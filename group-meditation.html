<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共修 - 虛空學佛網</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #8a6d3b;
            --secondary-color: #f8f5e6;
            --accent-color: #d4af37;
            --text-color: #333;
            --light-text: #f8f5e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Noto Sans TC", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--secondary-color);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 20px 0;
            position: relative;
            background-image: url('/api/placeholder/1200/400');
            background-size: cover;
            background-position: center;
            background-blend-mode: overlay;
        }

        .prayer-text {
            background-color: rgba(138, 109, 59, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 5px 5px 0;
            line-height: 1.8;
        }
        
        .prayer-text p {
            margin-bottom: 15px;
        }
        
        .prayer-text p:last-child {
            margin-bottom: 0;
        }

        
        .header-overlay {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px 0;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .logo h1 {
            font-size: 2.5rem;
            letter-spacing: 2px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        nav {
            display: flex;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px 0;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        nav li {
            margin: 0 15px;
        }
        
        nav a {
            color: var(--light-text);
            text-decoration: none;
            font-size: 1.1rem;
            padding: 5px 10px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        nav a:hover {
            background-color: var(--accent-color);
            color: var(--text-color);
        }
        
        main {
            padding: 40px 0;
            min-height: calc(100vh - 200px);
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 40px;
            color: var(--primary-color);
            font-size: 2rem;
        }
        
        .scripture-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            min-height: 600px;
        }
        
        .sidebar {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .sidebar h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--accent-color);
        }
        
        .scripture-menu {
            list-style: none;
        }
        
        .scripture-menu li {
            margin-bottom: 15px;
        }
        
        .scripture-menu a {
            display: block;
            color: var(--text-color);
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .scripture-menu a:hover,
        .scripture-menu a.active {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            padding-left: 20px;
        }
        
        .scripture-content {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            min-height: 600px;
            display: none;
        }
        
        .scripture-content.active {
            display: block;
        }
        
        .buddha-name {
            text-align: center;
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 40px;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .tools-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            width: 100%;
        }
        
        .tool-box {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            width: 80%;
            max-width: 600px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .tool-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .tool-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group input {
            width: 80%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1.1rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
        }
        
        .submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            background-color: var(--accent-color);
            transform: translateY(-3px);
        }
        
        .stat-display {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 5px;
            font-size: 1.1rem;
        }
        
        .or-divider {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            width: 100%;
        }
        
        .or-circle {
            width: 40px;
            height: 40px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .personal-stats {
            text-align: center;
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            font-size: 1.2rem;
        }
        
        footer {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 20px 0;
            text-align: center;
            margin-top: 40px;
        }
        
        .footer-content {
            margin-bottom: 15px;
        }
        
        .back-home {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 8px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin-top: 15px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .back-home:hover {
            background-color: var(--text-color);
            color: var(--light-text);
            transform: translateY(-3px);
        }
        
        /* 回到頂部按鈕的樣式 */
        #backToTopBtn {
            display: none; /* 初始隱藏按鈕 */
            position: fixed; /* 固定位置 */
            bottom: 20px; /* 距離底部20像素 */
            right: 30px; /* 距離右側30像素 */
            z-index: 99; /* 確保按鈕在其他元素上面 */
            border: none; /* 移除邊框 */
            outline: none; /* 移除焦點輪廓 */
            background-color: var(--primary-color, #8a6d3b); /* 使用網站主色調 */
            color: white; /* 白色文字 */
            cursor: pointer; /* 滑鼠指針變為手形 */
            padding: 15px; /* 內部填充 */
            border-radius: 50%; /* 圓形按鈕 */
            font-size: 18px; /* 文字大小 */
            width: 50px; /* 按鈕寬度 */
            height: 50px; /* 按鈕高度 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* 陰影效果 */
            transition: all 0.3s ease; /* 平滑過渡效果 */
        }

        #backToTopBtn:hover {
            background-color: var(--accent-color, #d4af37); /* 懸停時的背景色 */
            transform: translateY(-3px); /* 懸停時輕微上浮效果 */
        }
        
        /* 載入中動畫 */
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid var(--accent-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .scripture-layout {
                grid-template-columns: 1fr;
            }
            
            .logo h1 {
                font-size: 2rem;
            }
            
            .page-title {
                font-size: 1.7rem;
            }
            
            .tool-box {
                width: 90%;
                margin-bottom: 20px;
            }
            
            .personal-stats {
                width: 90%;
            }
            
            .or-divider {
                margin: 20px 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-overlay">
            <div class="container">
                <div class="logo">
                    <h1>虛空學佛網</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="index.html">首頁</a></li>
                        <li><a href="diamond-sutra.html">佛經選讀</a></li>
                        <li><a href="#">常備咒語</a></li>
                        <li><a href="#">人間佛教</a></li>
                        <li><a href="group-meditation.html">共修</a></li>
                        <li><a href="#">初學備忘錄</a></li>
                        <li><a href="#">感應故事</a></li>
                        <li><a href="#">線上問答</a></li>
                        <li><a href="index.html#contact">聯繫我們</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <h2 class="page-title">共修</h2>
            
            <div class="scripture-layout">
                <div class="sidebar">
                    <h3>選單</h3>
                    <ul class="scripture-menu">
                        <li><a href="#" class="scripture-link active" data-scripture="saha">娑婆世界一切眾生</a></li>
                        <li><a href="#" class="scripture-link" data-scripture="hell">十方世界一切地獄道、餓鬼道、畜生道的眾生</a></li>
                        <li><a href="#" class="scripture-link" data-scripture="infants">十方世界一切墮胎、流產的嬰靈</a></li>
                        <li><a href="#" class="scripture-link" data-scripture="marriage">一切眾生的婚姻</a></li>
                    </ul>
                </div>
                
                <!-- 娑婆世界一切眾生面板 -->
                <div id="saha-panel" class="scripture-content active">
                    <h2 class="buddha-name">「阿彌陀佛」聖號</h2>

                    <div class="prayer-text">
                        <h3 class="scripture-title">迴向文</h3>
                        <p>大慈大悲的阿彌陀佛。弟子以念誦您的聖號XX遍/XX分鐘的功德、福德，悉皆回向娑婆世界一切眾生。祈願您能夠轉化眾生心中的貪、瞋、癡，能夠賜予眾生更多念誦阿彌陀佛聖號的善緣，能夠光明遍照娑婆世界一切眾生，解脫一切眾生輪迴之苦，接引往生西方極樂世界。</p>
                        <p>願以此功德，普及於一切，我等與眾生，皆共成佛道。</p>
                        <p>願我臨欲命終時，盡除一切諸障礙，面見彼佛阿彌陀，即得往生安樂剎。</p>
                    </div>

                    <div class="tools-container">
                        <div class="tool-box counter-tool">
                            <h3 class="tool-title">計數器</h3>
                            <div class="input-group">
                                <input type="number" id="saha-count" min="1" placeholder="請輸入念誦次數" class="count-input">
                            </div>
                            <button class="submit-btn count-submit" data-panel="saha">送出</button>
                            <div class="loader" id="saha-count-loader"></div>
                            <div class="stat-display">
                                目前累積次數: <span class="total-count" id="saha-total-count">0</span> 遍
                            </div>
                        </div>
                        
                        <div class="or-divider">
                            <div class="or-circle">或</div>
                            <div class="personal-stats">
                                您念了 <span class="personal-count" id="saha-personal-count">0</span> 遍 或 <span class="personal-time" id="saha-personal-time">0</span> 分鐘
                            </div>
                        </div>
                        
                        <div class="tool-box timer-tool">
                            <h3 class="tool-title">計時器</h3>
                            <div class="input-group">
                                <input type="number" id="saha-time" min="1" placeholder="請輸入念誦分鐘數" class="time-input">
                            </div>
                            <button class="submit-btn time-submit" data-panel="saha">送出</button>
                            <div class="loader" id="saha-time-loader"></div>
                            <div class="stat-display">
                                目前累積時間: <span class="total-time" id="saha-total-time">0</span> 分鐘
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 十方世界一切地獄道、餓鬼道、畜生道的眾生面板 -->
                <div id="hell-panel" class="scripture-content">
                    <h2 class="buddha-name">「阿彌陀佛」聖號</h2>
                    
                    <div class="prayer-text">
                        <h3 class="scripture-title">迴向文</h3>
                        <p>大慈大悲的阿彌陀佛。弟子以念誦您的聖號XX遍/XX分鐘的功德、福德，悉皆回向十方世界一切地獄道、餓鬼道、畜生道的眾生。祈願您能夠轉化眾生心中的貪、瞋、癡，能夠轉化三惡道眾生的惡業，能夠光明遍照十方世界一切地獄、餓鬼、畜生，令三惡道眾生消除業障、解脫輪迴之苦，能夠接引三惡道眾生往生西方極樂世界。</p>
                        <p>願以此功德，普及於一切，我等與眾生，皆共成佛道。</p>
                        <p>願我臨欲命終時，盡除一切諸障礙，面見彼佛阿彌陀，即得往生安樂剎。</p>
                    </div>
                    
                    <div class="tools-container">
                        <div class="tool-box counter-tool">
                            <h3 class="tool-title">計數器</h3>
                            <div class="input-group">
                                <input type="number" id="hell-count" min="1" placeholder="請輸入念誦次數" class="count-input">
                            </div>
                            <button class="submit-btn count-submit" data-panel="hell">送出</button>
                            <div class="loader" id="hell-count-loader"></div>
                            <div class="stat-display">
                                目前累積次數: <span class="total-count" id="hell-total-count">0</span> 遍
                            </div>
                        </div>
                        
                        <div class="or-divider">
                            <div class="or-circle">或</div>
                            <div class="personal-stats">
                                您念了 <span class="personal-count" id="hell-personal-count">0</span> 遍 或 <span class="personal-time" id="hell-personal-time">0</span> 分鐘
                            </div>
                        </div>
                        
                        <div class="tool-box timer-tool">
                            <h3 class="tool-title">計時器</h3>
                            <div class="input-group">
                                <input type="number" id="hell-time" min="1" placeholder="請輸入念誦分鐘數" class="time-input">
                            </div>
                            <button class="submit-btn time-submit" data-panel="hell">送出</button>
                            <div class="loader" id="hell-time-loader"></div>
                            <div class="stat-display">
                                目前累積時間: <span class="total-time" id="hell-total-time">0</span> 分鐘
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 十方世界一切墮胎、流產的嬰靈面板 -->
                <div id="infants-panel" class="scripture-content">
                    <h2 class="buddha-name">「阿彌陀佛」聖號</h2>

                    <div class="prayer-text">
                        <h3 class="scripture-title">迴向文</h3>
                        <p>大慈大悲的阿彌陀佛。弟子以念誦您的聖號XX遍/XX分鐘的功德、福德，悉皆回向十方世界一切墮胎、流產的嬰靈。祈願您能夠轉化嬰靈心中的貪、瞋、癡，能夠轉化嬰靈心中的瞋恨，能夠光明遍照十方世界一切嬰靈，令他們消除業障、解脫輪迴之苦，能夠往生西方極樂世界。</p>
                        <p>願以此功德，普及於一切，我等與眾生，皆共成佛道。</p>
                        <p>願我臨欲命終時，盡除一切諸障礙，面見彼佛阿彌陀，即得往生安樂剎。</p>
                    </div>

                    <div class="tools-container">
                        <div class="tool-box counter-tool">
                            <h3 class="tool-title">計數器</h3>
                            <div class="input-group">
                                <input type="number" id="infants-count" min="1" placeholder="請輸入念誦次數" class="count-input">
                            </div>
                            <button class="submit-btn count-submit" data-panel="infants">送出</button>
                            <div class="loader" id="infants-count-loader"></div>
                            <div class="stat-display">
                                目前累積次數: <span class="total-count" id="infants-total-count">0</span> 遍
                            </div>
                        </div>
                        
                        <div class="or-divider">
                            <div class="or-circle">或</div>
                            <div class="personal-stats">
                                您念了 <span class="personal-count" id="infants-personal-count">0</span> 遍 或 <span class="personal-time" id="infants-personal-time">0</span> 分鐘
                            </div>
                        </div>
                        
                        <div class="tool-box timer-tool">
                            <h3 class="tool-title">計時器</h3>
                            <div class="input-group">
                                <input type="number" id="infants-time" min="1" placeholder="請輸入念誦分鐘數" class="time-input">
                            </div>
                            <button class="submit-btn time-submit" data-panel="infants">送出</button>
                            <div class="loader" id="infants-time-loader"></div>
                            <div class="stat-display">
                                目前累積時間: <span class="total-time" id="infants-total-time">0</span> 分鐘
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 一切眾生的婚姻面板 -->
                <div id="marriage-panel" class="scripture-content">
                    <h2 class="buddha-name">「觀世音菩薩」聖號</h2>
                    
                    <div class="prayer-text">
                        <h3 class="scripture-title">迴向文</h3>
                        <p>大慈大悲的觀世音菩薩。弟子以念誦您的聖號XX遍/XX分鐘的功德、福德，悉皆回向祈願十方世界一切眾生的婚姻都能夠得到善緣，能夠順利圓滿。</p>
                        <p>願以此功德，普及於一切，我等與眾生，皆共成佛道。</p>
                        <p>願我臨欲命終時，盡除一切諸障礙，面見彼佛阿彌陀，即得往生安樂剎。</p>
                    </div>

                    <div class="tools-container">
                        <div class="tool-box counter-tool">
                            <h3 class="tool-title">計數器</h3>
                            <div class="input-group">
                                <input type="number" id="marriage-count" min="1" placeholder="請輸入念誦次數" class="count-input">
                            </div>
                            <button class="submit-btn count-submit" data-panel="marriage">送出</button>
                            <div class="loader" id="marriage-count-loader"></div>
                            <div class="stat-display">
                                目前累積次數: <span class="total-count" id="marriage-total-count">0</span> 遍
                            </div>
                        </div>
                        
                        <div class="or-divider">
                            <div class="or-circle">或</div>
                            <div class="personal-stats">
                                您念了 <span class="personal-count" id="marriage-personal-count">0</span> 遍 或 <span class="personal-time" id="marriage-personal-time">0</span> 分鐘
                            </div>
                        </div>
                        
                        <div class="tool-box timer-tool">
                            <h3 class="tool-title">計時器</h3>
                            <div class="input-group">
                                <input type="number" id="marriage-time" min="1" placeholder="請輸入念誦分鐘數" class="time-input">
                            </div>
                            <button class="submit-btn time-submit" data-panel="marriage">送出</button>
                            <div class="loader" id="marriage-time-loader"></div>
                            <div class="stat-display">
                                目前累積時間: <span class="total-time" id="marriage-total-time">0</span> 分鐘
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2025 虛空學佛網 - 所有經文內容僅供學習參考</p>
            </div>
            <a href="index.html" class="back-home">返回主頁</a>
        </div>
    </footer>
    
    <button id="backToTopBtn" title="回到頂部">↑</button>

    <div class="user-data" style="display: none;">
      <!-- 通過 JavaScript 動態填充內容 -->
    </div>

    <div class="offline-queue" style="display: none;">
      <!-- 通過 JavaScript 動態填充內容 -->
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyBQBI80AK9wSycT1NrmKbFO4EL4-mUsSs0",
            authDomain: "buddha-83641.firebaseapp.com",
            databaseURL: "https://buddha-83641-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "buddha-83641",
            storageBucket: "buddha-83641.firebasestorage.app",
            messagingSenderId: "1030848359695",
            appId: "1:1030848359695:web:126ffab10c6259ff61627a"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        
        // 啟用離線持久化
        try {
            firebase.database().setPersistenceEnabled(true).catch(err => console.log('離線持久化設置失敗:', err));
        } catch (e) {
            console.log('離線持久化錯誤:', e);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase資料庫引用
            const db = firebase.database();
            const globalStatsRef = db.ref('共修網/global_stats');
            
            // 為關鍵數據啟用離線保存
            try {
                globalStatsRef.child('saha').keepSynced(true);
                globalStatsRef.child('hell').keepSynced(true);
                globalStatsRef.child('infants').keepSynced(true);
                globalStatsRef.child('marriage').keepSynced(true);
            } catch (e) {
                console.log('數據同步設置錯誤:', e);
            }
            
            // 顯示離線消息
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            function updateOnlineStatus() {
                const isOnline = navigator.onLine;
                if (!isOnline) {
                    alert('您已離線，數據將存儲在本地，待網絡恢復後自動同步');
                } else {
                    processOfflineQueue(); // 網絡恢復時立即處理離線隊列
                }
            }

            // 回到頂部按鈕
            const backToTopButton = document.getElementById('backToTopBtn');
            
            // 當用戶滾動超過200像素時顯示按鈕
            window.onscroll = function() {
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 200) {
                    backToTopButton.style.display = 'block';
                } else {
                    backToTopButton.style.display = 'none';
                }
            };
            
            // 點擊按鈕時滾動到頂部
            backToTopButton.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            // 處理經文切換
            const scriptureLinks = document.querySelectorAll('.scripture-link');
            const scripturePanels = document.querySelectorAll('.scripture-content');
            
            scriptureLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有active class
                    scriptureLinks.forEach(l => l.classList.remove('active'));
                    scripturePanels.forEach(p => p.classList.remove('active'));
                    
                    // 添加active class到當前點擊的鏈接
                    this.classList.add('active');
                    
                    // 顯示對應的面板
                    const scriptureId = this.getAttribute('data-scripture');
                    document.getElementById(`${scriptureId}-panel`).classList.add('active');
                });
            });
            
            // 生成或獲取設備ID
            let deviceId = localStorage.getItem('buddhaDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('buddhaDeviceId', deviceId);
            }
            
            // 本地數據
            let globalData = {
                saha: { totalCount: 0, totalTime: 0 },
                hell: { totalCount: 0, totalTime: 0 },
                infants: { totalCount: 0, totalTime: 0 },
                marriage: { totalCount: 0, totalTime: 0 }
            };
            
            // 個人數據
            let userData = {
                saha: { count: 0, time: 0 },
                hell: { count: 0, time: 0 },
                infants: { count: 0, time: 0 },
                marriage: { count: 0, time: 0 }
            };
            
            // 從localStorage讀取個人記錄
            if (localStorage.getItem('buddhaUserData')) {
                userData = JSON.parse(localStorage.getItem('buddhaUserData'));
            }
            
            // 從Firebase讀取全球數據
            globalStatsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    globalData = data;
                    updateDisplayedCounts();
                }
            });
            
            // 更新畫面顯示
            function updateDisplayedCounts() {
                // 更新全球計數顯示
                document.getElementById('saha-total-count').textContent = globalData.saha?.totalCount || 0;
                document.getElementById('hell-total-count').textContent = globalData.hell?.totalCount || 0;
                document.getElementById('infants-total-count').textContent = globalData.infants?.totalCount || 0;
                document.getElementById('marriage-total-count').textContent = globalData.marriage?.totalCount || 0;
                
                // 更新全球時間顯示
                document.getElementById('saha-total-time').textContent = globalData.saha?.totalTime || 0;
                document.getElementById('hell-total-time').textContent = globalData.hell?.totalTime || 0;
                document.getElementById('infants-total-time').textContent = globalData.infants?.totalTime || 0;
                document.getElementById('marriage-total-time').textContent = globalData.marriage?.totalTime || 0;
                
                // 更新個人計數顯示
                document.getElementById('saha-personal-count').textContent = userData.saha?.count || 0;
                document.getElementById('hell-personal-count').textContent = userData.hell?.count || 0;
                document.getElementById('infants-personal-count').textContent = userData.infants?.count || 0;
                document.getElementById('marriage-personal-count').textContent = userData.marriage?.count || 0;
                
                // 更新個人時間顯示
                document.getElementById('saha-personal-time').textContent = userData.saha?.time || 0;
                document.getElementById('hell-personal-time').textContent = userData.hell?.time || 0;
                document.getElementById('infants-personal-time').textContent = userData.infants?.time || 0;
                document.getElementById('marriage-personal-time').textContent = userData.marriage?.time || 0;
            }
            
            // 處理計數器提交
            const countSubmitBtns = document.querySelectorAll('.count-submit');
            countSubmitBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const panel = this.getAttribute('data-panel');
                    const countInput = document.getElementById(`${panel}-count`);
                    const count = parseInt(countInput.value) || 0;
                    
                    if (count > 0) {
                        // 顯示載入中
                        const loader = document.getElementById(`${panel}-count-loader`);
                        loader.style.display = 'block';
                        
                        // 檢查網絡連接
                        if (!navigator.onLine) {
                            // 離線模式：保存到本地
                            let offlineQueue = JSON.parse(localStorage.getItem('buddhaOfflineQueue') || '[]');
                            offlineQueue.push({
                                panel: panel,
                                type: 'count',
                                value: count,
                                timestamp: Date.now()
                            });
                            localStorage.setItem('buddhaOfflineQueue', JSON.stringify(offlineQueue));
                            
                            // 更新本地顯示
                            userData[panel].count = (userData[panel].count || 0) + count;
                            localStorage.setItem('buddhaUserData', JSON.stringify(userData));
                            
                            // 清空輸入框並隱藏加載器
                            countInput.value = '';
                            loader.style.display = 'none';
                            updateDisplayedCounts();
                            alert(`已記錄 ${count} 遍念誦！將在網絡恢復後同步。`);
                            return;
                        }
                        
                        // 在線模式：直接更新Firebase
                        const panelRef = globalStatsRef.child(panel);
                        panelRef.transaction((currentData) => {
                            if (currentData === null) {
                                return { totalCount: count, totalTime: 0 };
                            } else {
                                return {
                                    totalCount: (currentData.totalCount || 0) + count,
                                    totalTime: currentData.totalTime || 0
                                };
                            }
                        }).then(() => {
                            // 更新個人計數
                            userData[panel].count = count;
                            localStorage.setItem('buddhaUserData', JSON.stringify(userData));
                            
                            // 清空輸入框
                            countInput.value = '';
                            
                            // 隱藏載入中
                            loader.style.display = 'none';
                            
                            // 更新顯示
                            updateDisplayedCounts();
                            
                            // 顯示提交成功提示
                            alert(`已成功記錄 ${count} 遍念誦！`);
                        }).catch(error => {
                            console.error('提交失敗:', error);
                            loader.style.display = 'none';
                            
                            // 將失敗的數據添加到離線隊列
                            let offlineQueue = JSON.parse(localStorage.getItem('buddhaOfflineQueue') || '[]');
                            offlineQueue.push({
                                panel: panel,
                                type: 'count',
                                value: count,
                                timestamp: Date.now()
                            });
                            localStorage.setItem('buddhaOfflineQueue', JSON.stringify(offlineQueue));
                            
                            alert('提交失敗，數據已保存在本地，將在網絡恢復後自動同步。');
                        });
                    } else {
                        alert('請輸入有效的念誦次數');
                    }
                });
            });
            
            // 處理計時器提交
            const timeSubmitBtns = document.querySelectorAll('.time-submit');
            timeSubmitBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const panel = this.getAttribute('data-panel');
                    const timeInput = document.getElementById(`${panel}-time`);
                    const time = parseInt(timeInput.value) || 0;
                    
                    if (time > 0) {
                        // 顯示載入中
                        const loader = document.getElementById(`${panel}-time-loader`);
                        loader.style.display = 'block';
                        
                        // 檢查網絡連接
                        if (!navigator.onLine) {
                            // 離線模式：保存到本地
                            let offlineQueue = JSON.parse(localStorage.getItem('buddhaOfflineQueue') || '[]');
                            offlineQueue.push({
                                panel: panel,
                                type: 'time',
                                value: time,
                                timestamp: Date.now()
                            });
                            localStorage.setItem('buddhaOfflineQueue', JSON.stringify(offlineQueue));
                            
                            // 更新本地顯示
                            userData[panel].time = (userData[panel].time || 0) + time;
                            localStorage.setItem('buddhaUserData', JSON.stringify(userData));
                            
                            // 清空輸入框並隱藏加載器
                            timeInput.value = '';
                            loader.style.display = 'none';
                            updateDisplayedCounts();
                            alert(`已記錄 ${time} 分鐘念誦時間！將在網絡恢復後同步。`);
                            return;
                        }
                        
                        // 更新全球時間
                        const panelRef = globalStatsRef.child(panel);
                        panelRef.transaction((currentData) => {
                            if (currentData === null) {
                                return { totalCount: 0, totalTime: time };
                            } else {
                                return {
                                    totalCount: currentData.totalCount || 0,
                                    totalTime: (currentData.totalTime || 0) + time
                                };
                            }
                        }).then(() => {
                            // 更新個人時間
                            userData[panel].time = time;
                            localStorage.setItem('buddhaUserData', JSON.stringify(userData));
                            
                            // 清空輸入框
                            timeInput.value = '';
                            
                            // 隱藏載入中
                            loader.style.display = 'none';
                            
                            // 更新顯示
                            updateDisplayedCounts();
                            
                            // 顯示提交成功提示
                            alert(`已成功記錄 ${time} 分鐘念誦時間！`);
                        }).catch(error => {
                            console.error('提交失敗:', error);
                            loader.style.display = 'none';
                            
                            // 將失敗的數據添加到離線隊列
                            let offlineQueue = JSON.parse(localStorage.getItem('buddhaOfflineQueue') || '[]');
                            offlineQueue.push({
                                panel: panel,
                                type: 'time',
                                value: time,
                                timestamp: Date.now()
                            });
                            localStorage.setItem('buddhaOfflineQueue', JSON.stringify(offlineQueue));
                            
                            alert('提交失敗，數據已保存在本地，將在網絡恢復後自動同步。');
                        });
                    } else {
                        alert('請輸入有效的念誦時間');
                    }
                });
            });
            
            // 處理離線隊列的上傳
            function processOfflineQueue() {
                let offlineQueue = JSON.parse(localStorage.getItem('buddhaOfflineQueue') || '[]');
                if (offlineQueue.length > 0 && navigator.onLine) {
                    console.log('處理離線隊列，項目數量:', offlineQueue.length);
                    
                    // 處理第一個項目
                    const item = offlineQueue[0];
                    const panelRef = globalStatsRef.child(item.panel);
                    
                    panelRef.transaction((currentData) => {
                        if (currentData === null) {
                            if (item.type === 'count') {
                                return { totalCount: item.value, totalTime: 0 };
                            } else {
                                return { totalCount: 0, totalTime: item.value };
                            }
                        } else {
                            if (item.type === 'count') {
                                return {
                                    totalCount: (currentData.totalCount || 0) + item.value,
                                    totalTime: currentData.totalTime || 0
                                };
                            } else {
                                return {
                                    totalCount: currentData.totalCount || 0,
                                    totalTime: (currentData.totalTime || 0) + item.value
                                };
                            }
                        }
                    }).then(() => {
                        // 上傳成功，從隊列中移除
                        offlineQueue.shift();
                        localStorage.setItem('buddhaOfflineQueue', JSON.stringify(offlineQueue));
                        
                        // 如果還有項目，繼續處理
                        if (offlineQueue.length > 0) {
                            setTimeout(processOfflineQueue, 1000);
                        }
                    }).catch(error => {
                        console.error('處理離線隊列時出錯:', error);
                        // 如果處理失敗，稍後再嘗試
                        setTimeout(processOfflineQueue, 5000);
                    });
                }
            }
            
            // 網絡恢復時處理離線隊列
            window.addEventListener('online', processOfflineQueue);
            
            // 定期檢查並處理離線隊列
            setInterval(processOfflineQueue, 60000); // 每分鐘檢查一次
            
            // 頁面載入時立即嘗試處理離線隊列
            if (navigator.onLine) {
                processOfflineQueue();
            }
            
            // 頁面載入時更新顯示
            updateDisplayedCounts();
        });
    </script>
</body>
</html>